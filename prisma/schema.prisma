// Franchise POS System - Central Database Schema
// This schema supports a SaaS multi-branch coffee shop franchise with centralized control

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT & AUTHENTICATION
// ============================================

model User {
  id           String   @id @default(cuid())
  username     String   @unique
  email        String   @unique
  passwordHash String
  name         String?
  role         UserRole  @default(CASHIER)
  branchId     String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  branch          Branch?              @relation(fields: [branchId], references: [id], onDelete: SetNull)
  orders          Order[]
  inventoryTxns   InventoryTransaction[]
  auditLogs       AuditLog[]
  modifiedInventories BranchInventory[]  @relation("InventoryModifier")
  shifts          Shift[]

  @@index([username])
  @@index([branchId])
}

enum UserRole {
  ADMIN        // HQ Admin - Full control
  BRANCH_MANAGER
  CASHIER
}

// ============================================
// BRANCH MANAGEMENT & LICENSING
// ============================================

model Branch {
  id               String   @id @default(cuid())
  branchName       String   @unique
  licenseKey       String   @unique
  licenseExpiresAt DateTime
  isActive         Boolean  @default(true)
  lastSyncAt       DateTime?
  menuVersion      Int      @default(1)
  pricingVersion   Int      @default(1)
  recipeVersion    Int      @default(1)
  ingredientVersion Int     @default(1)
  userVersion      Int      @default(1)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  serialYear      Int      @default(2024)
  lastSerial      Int      @default(0)

  users             User[]
  customers         Customer[]
  branchInventory   BranchInventory[]
  orders            Order[]
  inventoryTxns     InventoryTransaction[]
  syncHistory       SyncHistory[]
  syncConflicts     SyncConflict[]
  shifts            Shift[]
  costs             BranchCost[]
  couriers          Courier[]

  @@index([licenseKey])
  @@index([isActive])
}

model BranchLicense {
  id             String   @id @default(cuid())
  branchId       String
  licenseKey     String   @unique
  activationDate DateTime @default(now())
  expirationDate DateTime
  maxDevices     Int      @default(1)
  isRevoked      Boolean  @default(false)
  revokedReason  String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([branchId])
  @@index([licenseKey])
}

// ============================================
// MENU & PRICING (CENTRAL CONTROL)
// ============================================

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  defaultVariantTypeId String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  menuItems MenuItem[]
  defaultVariantType VariantType? @relation("CategoryVariantType", fields: [defaultVariantTypeId], references: [id], onDelete: SetNull)

  @@index([sortOrder])
  @@index([isActive])
}

model MenuItem {
  id          String   @id @default(cuid())
  name        String
  category    String
  categoryId  String?
  price       Float
  taxRate     Float    @default(0.14)
  isActive    Boolean  @default(true)
  imagePath   String?
  sortOrder   Int?
  hasVariants Boolean  @default(false)
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  categoryRel Category?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  recipes     Recipe[]
  orderItems  OrderItem[]
  variants    MenuItemVariant[]

  @@index([category])
  @@index([categoryId])
  @@index([isActive])
  @@index([version])
  @@index([hasVariants])
}

model Recipe {
  id               String   @id @default(cuid())
  menuItemId       String
  ingredientId     String
  quantityRequired Float
  unit             String
  menuItemVariantId String?
  version          Int      @default(1)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  menuItem    MenuItem    @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  ingredient Ingredient  @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  variant    MenuItemVariant? @relation(fields: [menuItemVariantId], references: [id], onDelete: Cascade)

  @@unique([menuItemId, ingredientId, menuItemVariantId])
  @@index([menuItemId])
  @@index([menuItemVariantId])
  @@index([version])
}

model Ingredient {
  id               String            @id @default(cuid())
  name             String            @unique
  unit             String            // 'kg', 'L', 'unit', 'g', 'ml'
  costPerUnit      Float
  reorderThreshold Float
  version          Int               @default(1)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  recipes         Recipe[]
  branchInventory BranchInventory[]
  inventoryTxns   InventoryTransaction[]

  @@index([name])
  @@index([version])
}

// ============================================
// VARIANT MANAGEMENT
// ============================================

model VariantType {
  id          String   @id @default(cuid())
  name        String   @unique  // 'Size', 'Weight', 'Color'
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  menuItemVariants MenuItemVariant[]
  categories         Category[] @relation("CategoryVariantType")
  options            VariantOption[]

  @@index([isActive])
}

model VariantOption {
  id            String   @id @default(cuid())
  variantTypeId String
  name          String   // 'Regular', 'Large', '250g', '500g', '1kg'
  description   String?
  sortOrder     Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  variantType VariantType @relation(fields: [variantTypeId], references: [id], onDelete: Cascade)
  menuItemVariants MenuItemVariant[]

  @@unique([variantTypeId, name])
  @@index([variantTypeId])
  @@index([isActive])
}

model MenuItemVariant {
  id            String   @id @default(cuid())
  menuItemId    String
  variantTypeId String
  variantOptionId String
  priceModifier Float    @default(0)  // + or - from base price
  sortOrder     Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  menuItem    MenuItem    @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  variantType VariantType @relation(fields: [variantTypeId], references: [id], onDelete: Cascade)
  variantOption VariantOption @relation(fields: [variantOptionId], references: [id], onDelete: Cascade)
  recipes     Recipe[]

  @@unique([menuItemId, variantOptionId])
  @@index([menuItemId])
  @@index([variantTypeId])
  @@index([variantOptionId])
  @@index([isActive])
}

// ============================================
// INVENTORY MANAGEMENT
// ============================================

model BranchInventory {
  id              String   @id @default(cuid())
  branchId        String
  ingredientId    String
  currentStock    Float    @default(0)
  lastRestockAt   DateTime?
  lastModifiedAt  DateTime @default(now())
  lastModifiedBy  String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  branch     Branch     @relation(fields: [branchId], references: [id], onDelete: Cascade)
  ingredient Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  modifier   User?       @relation("InventoryModifier", fields: [lastModifiedBy], references: [id])

  @@unique([branchId, ingredientId])
  @@index([branchId])
  @@index([ingredientId])
}

model InventoryTransaction {
  id             String               @id @default(cuid())
  branchId       String
  ingredientId   String
  transactionType InventoryTxnType
  quantityChange Float
  stockBefore    Float
  stockAfter     Float
  orderId        String?
  reason         String?
  createdBy      String
  createdAt      DateTime             @default(now())

  branch     Branch     @relation(fields: [branchId], references: [id], onDelete: Cascade)
  ingredient Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  order      Order?     @relation(fields: [orderId], references: [id])
  creator    User       @relation(fields: [createdBy], references: [id])

  @@index([branchId])
  @@index([ingredientId])
  @@index([orderId])
  @@index([createdAt])
}

enum InventoryTxnType {
  SALE
  WASTE
  REFUND
  ADJUSTMENT
  RESTOCK
}

// ============================================
// COST MANAGEMENT
// ============================================

model CostCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  icon        String?  // Icon name for UI (optional)
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  costs BranchCost[]

  @@index([sortOrder])
  @@index([isActive])
}

model BranchCost {
  id             String   @id @default(cuid())
  branchId       String
  costCategoryId String
  amount         Float
  period         String   // Format: "YYYY-MM" (e.g., "2025-01")
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  branch       Branch       @relation(fields: [branchId], references: [id], onDelete: Cascade)
  costCategory CostCategory @relation(fields: [costCategoryId], references: [id], onDelete: Cascade)

  @@index([branchId])
  @@index([costCategoryId])
  @@index([period])
  @@index([branchId, period])
}

// ============================================
// ORDERS & SALES
// ============================================

model InvoiceSerial {
  id             String   @id @default(cuid())
  branchId       String
  year           Int
  lastSerial     Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([branchId, year])
  @@index([branchId, year])
}

model Order {
  id               String   @id @default(cuid())
  branchId         String
  orderNumber      Int
  orderTimestamp   DateTime @default(now())
  cashierId        String
  subtotal         Float
  totalAmount      Float
  paymentMethod    String
  orderType        String   @default("dine-in") // 'dine-in' | 'take-away' | 'delivery'
  deliveryAddress  String? // For delivery orders
  deliveryAreaId  String? // References DeliveryArea model
  deliveryFee     Float   @default(0) // Delivery fee based on area
  isRefunded       Boolean  @default(false)
  refundReason     String?
  transactionHash  String   @unique
  synced           Boolean  @default(false)
  shiftId          String?
  customerId       String?
  customerAddressId String?
  courierId        String? // Delivery courier
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  branch   Branch      @relation(fields: [branchId], references: [id], onDelete: Cascade)
  cashier  User        @relation(fields: [cashierId], references: [id])
  shift    Shift?      @relation(fields: [shiftId], references: [id], onDelete: SetNull)
  deliveryArea DeliveryArea? @relation(fields: [deliveryAreaId], references: [id])
  customer      Customer?      @relation(fields: [customerId], references: [id], onDelete: SetNull)
  customerAddress CustomerAddress? @relation(fields: [customerAddressId], references: [id], onDelete: SetNull)
  courier   Courier?   @relation(fields: [courierId], references: [id], onDelete: SetNull)
  items    OrderItem[]
  inventoryTxns InventoryTransaction[]

  @@unique([branchId, orderNumber])
  @@index([branchId])
  @@index([orderTimestamp])
  @@index([synced])
  @@index([transactionHash])
  @@index([shiftId])
  @@index([orderType])
  @@index([deliveryAreaId])
  @@index([customerId])
  @@index([customerAddressId])
  @@index([courierId])
}

model DeliveryArea {
  id        String   @id @default(cuid())
  name      String
  fee       Float
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders           Order[]
  customerAddresses CustomerAddress[]

  @@index([isActive])
}

model Courier {
  id        String   @id @default(cuid())
  name      String
  phone     String?
  branchId  String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branch Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  orders Order[]

  @@index([branchId])
  @@index([isActive])
}

model OrderItem {
  id            String   @id @default(cuid())
  orderId       String
  menuItemId    String
  itemName      String
  quantity      Int
  unitPrice     Float
  subtotal      Float
  recipeVersion Int
  menuItemVariantId String?  // Selected variant
  variantName   String?  // Display name of variant (e.g., "Large", "500g")
  createdAt     DateTime @default(now())

  order    Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([menuItemId])
  @@index([menuItemVariantId])
}

// ============================================
// SYNC & AUDIT
// ============================================

model SyncHistory {
  id             String        @id @default(cuid())
  branchId       String
  syncDirection  SyncDirection
  recordsAffected Int
  syncStartedAt  DateTime      @default(now())
  syncCompletedAt DateTime?
  status         SyncStatus
  errorDetails   String?

  branch Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@index([branchId])
  @@index([syncStartedAt])
}

enum SyncDirection {
  UP     // Branch → Central
  DOWN   // Central → Branch
}

enum SyncStatus {
  SUCCESS
  PARTIAL
  FAILED
}

model SyncConflict {
  id             String   @id @default(cuid())
  branchId       String
  entityType     String
  entityId       String
  conflictReason String
  branchPayload  String?
  centralPayload String?
  detectedAt     DateTime @default(now())
  resolvedAt     DateTime?
  resolvedBy     String?
  resolution     ConflictResolution?

  branch Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@index([branchId])
  @@index([detectedAt])
}

enum ConflictResolution {
  ACCEPT_BRANCH
  ACCEPT_CENTRAL
  MANUAL_MERGE
}

model AuditLog {
  id           String   @id @default(cuid())
  timestamp    DateTime @default(now())
  userId       String
  actionType   String   // 'sale', 'refund', 'inventory_adjust', 'login', 'menu_sync'
  entityType   String?
  entityId     String?
  oldValue     String?
  newValue     String?
  ipAddress    String?
  previousHash String?
  currentHash  String

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([timestamp])
  @@index([actionType])
}

// ============================================
// SHIFT MANAGEMENT
// ============================================

model Shift {
  id              String   @id @default(cuid())
  branchId        String
  cashierId       String
  startTime       DateTime @default(now())
  endTime         DateTime?
  openingCash      Float    @default(0)
  closingCash      Float?
  openingOrders    Int      @default(0)
  closingOrders    Int?
  openingRevenue   Float    @default(0)
  closingRevenue   Float?
  isClosed         Boolean  @default(false)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  branch  Branch  @relation(fields: [branchId], references: [id], onDelete: Cascade)
  cashier User    @relation(fields: [cashierId], references: [id])
  orders   Order[]

  @@index([branchId])
  @@index([cashierId])
  @@index([startTime])
  @@index([isClosed])
}

// ============================================
// CUSTOMER MANAGEMENT
// ============================================

model Customer {
  id         String   @id @default(cuid())
  name       String
  phone      String   @unique
  email      String?
  notes      String?
  branchId   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  branch   Branch?          @relation(fields: [branchId], references: [id], onDelete: SetNull)
  addresses CustomerAddress[]
  orders   Order[]

  @@index([phone])
  @@index([branchId])
  @@index([createdAt])
}

model CustomerAddress {
  id               String   @id @default(cuid())
  customerId       String
  building         String?
  streetAddress    String
  floor            String?
  apartment        String?
  deliveryAreaId   String?
  isDefault        Boolean  @default(false)
  orderCount       Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  customer      Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  deliveryArea DeliveryArea? @relation(fields: [deliveryAreaId], references: [id], onDelete: SetNull)
  orders        Order[]

  @@index([customerId])
  @@index([deliveryAreaId])
  @@index([createdAt])
}
